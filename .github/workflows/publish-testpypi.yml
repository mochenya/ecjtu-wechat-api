name: ğŸ§ª å‘å¸ƒ dev ç‰ˆåˆ° TestPyPI

on:
  push:
    branches:
      - dev

permissions:
  contents: read
  id-token: write

jobs:
  publish-testpypi:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºå®Œæ•´å†å²ä»£ç 
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: ğŸ”„ åŒæ­¥é¡¹ç›®ä¾èµ–
        run: uv sync

      - name: ğŸ”¢ è®¡ç®—å¼€å‘ç‰ˆæœ¬å·
        id: version
        run: |
          # è¯»å– fallback-version ä½œä¸ºåŸºç¡€ç‰ˆæœ¬
          BASE_VERSION=$(grep 'fallback-version' pyproject.toml | sed 's/.*= "\(.*\)"/\1/')

          # ä½¿ç”¨ github run number ä½œä¸º dev åç¼€
          NEW_VERSION="${BASE_VERSION}.dev${{ github.run_number }}"

          echo "version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"
          echo "ğŸ”¢ æœ€ç»ˆç‰ˆæœ¬å·: $NEW_VERSION"

      - name: ğŸ—ï¸ æ„å»ºé¡¹ç›®
        run: |
          # é€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥ç‰ˆæœ¬å·ç»™ hatch-vcs
          export SETUPTOOLS_SCM_PRETEND_VERSION="${{ steps.version.outputs.version }}"
          uv build
        env:
          SETUPTOOLS_SCM_PRETEND_VERSION: ${{ steps.version.outputs.version }}

      - name: ğŸš€ å‘å¸ƒåˆ° TestPyPI
        run: |
          uv publish \
            --publish-url https://test.pypi.org/legacy/ \
            --check-url https://test.pypi.org/simple/ \
            dist/*
